<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XSM VPN</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
    --color-bg: #050a18;
    --color-bg-card: #0a1128;
    --color-primary: #00ddff;
    --color-secondary: #7700ff;
    --color-accent: #ff00aa;
    --color-text: #e0f7ff;
    --color-text-dim: #8ba3b8;
    --color-success: #00ffaa;
    --color-error: #ff2266;
    --color-input-bg: rgba(0, 221, 255, 0.05);
    --color-input-border: rgba(0, 221, 255, 0.2);
    --glow-primary: 0 0 10px rgba(0, 221, 255, 0.5), 0 0 20px rgba(0, 221, 255, 0.2);
    --glow-secondary: 0 0 10px rgba(119, 0, 255, 0.5), 0 0 20px rgba(119, 0, 255, 0.2);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --card-width: 100%;
    --card-max-width: 480px;
    --card-padding: 1.5rem;
    --card-border-radius: 12px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Rajdhani', sans-serif;
    background-color: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 221, 255, 0.03) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(119, 0, 255, 0.03) 0%, transparent 20%),
        linear-gradient(rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.2) 100%);
    background-attachment: fixed;
    position: relative;
    overflow-x: hidden;
    padding: 1rem 0;
}

body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(90deg, var(--color-bg) 21px, transparent 1%) center,
        linear-gradient(var(--color-bg) 21px, transparent 1%) center;
    background-size: 22px 22px;
    background-color: transparent;
    opacity: 0.2;
    z-index: -1;
}

.container {
    width: var(--card-width);
    max-width: var(--card-max-width);
    padding: 0 0.75rem;
    margin-bottom: 1rem;
}

.card {
    background: var(--color-bg-card);
    border-radius: var(--card-border-radius);
    padding: var(--card-padding);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0, 221, 255, 0.1);
    width: 100%;
}

.card::before, .footer::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary), var(--color-accent));
}

.card::after, .footer::after {
    content: "";
    position: absolute;
    top: 3px;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, 
        rgba(0, 221, 255, 0.5), 
        rgba(119, 0, 255, 0.5), 
        rgba(255, 0, 170, 0.5));
    filter: blur(1px);
}

.title-container {
    text-align: center;
    margin-bottom: 1.5rem;
    position: relative;
}

.title {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1px;
    margin: 0;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
}

.title::after {
    content: "SUB";
    position: absolute;
    top: -8px;
    right: -30px;
    font-size: 0.7rem;
    font-weight: 400;
    background: var(--color-accent);
    color: var(--color-bg);
    padding: 2px 5px;
    border-radius: 3px;
    -webkit-text-fill-color: var(--color-bg);
    transform: rotate(15deg);
}

.subtitle {
    font-size: 0.9rem;
    color: var(--color-text-dim);
    margin-top: 0.3rem;
}

.form-group {
    margin-bottom: 1.2rem;
    position: relative;
}

.form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text);
    letter-spacing: 0.5px;
}

.form-control {
    width: 100%;
    padding: 0.7rem 0.8rem;
    background: var(--color-input-bg);
    border: 1px solid var(--color-input-border);
    border-radius: 8px;
    color: var(--color-text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    transition: var(--transition);
}

.form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: var(--glow-primary);
}

select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2300ddff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.8rem center;
    background-size: 1rem;
    padding-right: 2.2rem;
}

.btn {
    width: 100%;
    padding: 0.8rem;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    color: var(--color-bg);
    border: none;
    border-radius: 8px;
    font-family: 'Orbitron', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

.btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    box-shadow: var(--glow-primary);
    transform: translateY(-2px);
}

.loading {
    display: none;
    text-align: center;
    margin: 1.5rem 0;
    color: var(--color-primary);
}

.spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 3px solid rgba(0, 221, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 0.8rem;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    letter-spacing: 1px;
}

.result {
    display: none;
    margin-top: 1.5rem;
    position: relative;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.result-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    color: var(--color-success);
}

.output-container {
    position: relative;
    margin-bottom: 0.8rem;
}

.output {
    width: 100%;
    height: 180px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-input-border);
    border-radius: 8px;
    color: var(--color-text);
    padding: 0.8rem;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    resize: vertical;
    line-height: 1.4;
}

.output:focus {
    outline: none;
    border-color: var(--color-primary);
}

.copy-btn {
    background: linear-gradient(90deg, var(--color-success), var(--color-primary));
    color: var(--color-bg);
    border: none;
    border-radius: 8px;
    padding: 0.7rem 1rem;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
}

.copy-btn:hover {
    box-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
    transform: translateY(-2px);
}

.copy-icon {
    width: 16px;
    height: 16px;
}

.error-message {
    color: var(--color-error);
    text-align: center;
    margin-top: 0.8rem;
    font-weight: 500;
    font-size: 0.9rem;
}

/* Responsive adjustments */
@media (max-width: 480px) {
    :root {
        --card-padding: 1.2rem;
    }
    
    .container {
        padding: 0 0.5rem;
    }
    
    .title {
        font-size: 1.5rem;
    }
    
    .subtitle {
        font-size: 0.8rem;
    }
    
    .form-group label {
        font-size: 0.9rem;
    }
    
    .form-control {
        padding: 0.6rem 0.7rem;
        font-size: 0.9rem;
    }
    
    .btn {
        padding: 0.7rem;
        font-size: 0.9rem;
    }
}

/* Cyberpunk details */
.tech-detail {
    position: absolute;
    background: var(--color-primary);
    opacity: 0.1;
    z-index: -1;
}

.tech-detail-1 {
    width: 40px;
    height: 40px;
    top: 20px;
    right: 20px;
    border-radius: 50%;
    box-shadow: 0 0 20px var(--color-primary);
}

.tech-detail-2 {
    width: 80px;
    height: 2px;
    bottom: 40px;
    left: -20px;
    transform: rotate(45deg);
}

.tech-detail-3 {
    width: 15px;
    height: 15px;
    bottom: 20px;
    right: 40px;
    transform: rotate(45deg);
}

/* Animated typing effect for loading */
.typing {
    overflow: hidden;
    white-space: nowrap;
    border-right: 2px solid var(--color-primary);
    width: 0;
    animation: typing 3s steps(30, end) infinite;
}

@keyframes typing {
    0% { width: 0 }
    80% { width: 100% }
    100% { width: 100% }
}

.form-group.uuid-group {
    position: relative;
}

.uuid-generate {
    position: absolute;
    right: 8px;
    top: 36px;
    background: rgba(0, 221, 255, 0.1);
    border: none;
    color: var(--color-primary);
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
    transition: var(--transition);
}

.uuid-generate:hover {
    background: rgba(0, 221, 255, 0.2);
}

.form-row {
    display: flex;
    gap: 0.8rem;
    margin-bottom: 1.2rem;
}

.form-row .form-group {
    flex: 1;
    margin-bottom: 0;
}

.info-badge {
    display: inline-block;
    background: var(--color-accent);
    color: var(--color-bg);
    font-size: 0.65rem;
    padding: 1px 5px;
    border-radius: 3px;
    margin-left: 5px;
    vertical-align: middle;
    font-weight: 600;
}

.custom-bug-container {
    display: none;
}

/* Footer styles */
.footer {
    width: var(--card-width);
    max-width: var(--card-max-width);
    background: var(--color-bg-card);
    border-radius: var(--card-border-radius);
    padding: 1.2rem;
    position: relative;
    border: 1px solid rgba(0, 221, 255, 0.1);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    overflow: hidden;
    margin: 0 0.75rem;
}

.footer-logo {
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
}

.footer-powered {
    font-size: 0.8rem;
    color: var(--color-text-dim);
    margin-bottom: 0.6rem;
    font-family: 'Share Tech Mono', monospace;
}

.footer-social {
    display: flex;
    justify-content: center;
    gap: 0.8rem;
    margin-bottom: 0.6rem;
    flex-wrap: wrap;
}

.social-link {
    color: var(--color-primary);
    text-decoration: none;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    background: rgba(0, 221, 255, 0.05);
    border: 1px solid rgba(0, 221, 255, 0.1);
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.social-link:hover {
    background: rgba(0, 221, 255, 0.1);
    box-shadow: var(--glow-primary);
    transform: translateY(-2px);
}

.social-icon {
    width: 14px;
    height: 14px;
}

.footer-year {
    font-family: 'Orbitron', sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--color-accent);
    margin-top: 0.4rem;
    letter-spacing: 1px;
}

.circuit-line {
    position: absolute;
    background: var(--color-primary);
    opacity: 0.1;
}

.circuit-line-1 {
    width: 60px;
    height: 1px;
    top: 20px;
    left: 20px;
}

.circuit-line-2 {
    width: 1px;
    height: 30px;
    top: 20px;
    left: 20px;
}

.circuit-line-3 {
    width: 40px;
    height: 1px;
    bottom: 25px;
    right: 30px;
}

.circuit-line-4 {
    width: 1px;
    height: 25px;
    bottom: 25px;
    right: 30px;
}

.circuit-dot {
    position: absolute;
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: var(--color-primary);
    opacity: 0.2;
}

.circuit-dot-1 {
    top: 20px;
    left: 20px;
}

.circuit-dot-2 {
    top: 50px;
    left: 20px;
}

.circuit-dot-3 {
    bottom: 25px;
    right: 30px;
}

.circuit-dot-4 {
    bottom: 50px;
    right: 30px;
}

/* Validation status styles */
.validation-status {
    display: none;
    margin-top: 1rem;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    color: var(--color-text-dim);
}

.validation-progress {
    margin-top: 0.5rem;
    height: 6px;
    width: 100%;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
    overflow: hidden;
}

.validation-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    transition: width 0.3s ease;
}

.validation-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-size: 0.8rem;
}

.validation-check {
    margin-right: 0.5rem;
    display: inline-block;
    width: 16px;
    height: 16px;
}

.form-group.validation-group {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.form-check {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.form-check-input {
    margin-right: 0.5rem;
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--color-primary);
}

.form-check-label {
    font-size: 0.9rem;
    cursor: pointer;
}
</style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="tech-detail tech-detail-1"></div>
        <div class="tech-detail tech-detail-2"></div>
        <div class="tech-detail tech-detail-3"></div>
        
        <div class="title-container">
            <h1 class="title">XSM VPN</h1>
            <p class="subtitle">Advanced Subscription Link Generator</p>
        </div>
        
        <form id="subLinkForm">
            <div class="form-group">
                <label for="configType">PROTOCOL TYPE</label>
                <select id="configType" class="form-control" required>
                    <option value="vless">VLESS</option>
                    <option value="vmess">VMESS</option>
                    <option value="trojan">TROJAN</option>
                    <option value="shadowsocks">SHADOWSOCKS</option>
                    <option value="mix">MIX (ALL PROTOCOLS)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="formatType">FORMAT TYPE</label>
                <select id="formatType" class="form-control" required>
                    <option value="v2ray">V2RAY</option>
                    <option value="clash">CLASH</option>
                </select>
            </div>
            
            <div class="form-group uuid-group">
                <label for="uuid">UUID</label>
                <input type="text" id="uuid" class="form-control" value="1e81508a-0a3e-4866-ab0c-e2ca4cdd8892" required>
                <button type="button" id="generateUuid" class="uuid-generate">GENERATE</button>
            </div>
            
            <div class="form-group">
                <label for="bugType">BUG TYPE</label>
                <select id="bugType" class="form-control" required>
                    <option value="default">DEFAULT</option>
                    <option value="non-wildcard">NON-WILDCARD</option>
                    <option value="wildcard">WILDCARD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="mainDomain">MAIN DOMAIN <span class="info-badge">DEFAULT</span></label>
                <input type="text" id="mainDomain" class="form-control" value="2359.biz.id" required>
            </div>
            
            <div id="customBugContainer" class="form-group custom-bug-container">
                <label for="customBug">CUSTOM BUG</label>
                <input type="text" id="customBug" class="form-control" placeholder="e.g., google.com">
            </div>
            
            <div class="form-group">
                <label for="tls">TLS ENCRYPTION</label>
                <select id="tls" class="form-control">
                    <option value="true">ENABLED</option>
                    <option value="false">DISABLED</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="country">REGION FILTER</label>
                    <select id="country" class="form-control">
                        <option value="">Loading regions...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="limit">QUANTITY</label>
                    <input type="number" id="limit" class="form-control" min="1" max="20" value="5" placeholder="Max 20" required>
                </div>
            </div>
            
            <div class="form-group validation-group">
                <label class="form-check">
                    <input type="checkbox" id="validateProxies" class="form-check-input" checked>
                    <span class="form-check-label">Validate proxies before generating</span>
                </label>
            </div>
            
            <button type="submit" class="btn">Generate Configuration</button>
        </form>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div class="loading-text typing">Fetching proxy data and generating configs...</div>
        </div>
        
        <div id="validation-status" class="validation-status">
            <div>Validating proxies... <span id="validation-count">0/0</span></div>
            <div class="validation-progress">
                <div id="validation-bar" class="validation-bar"></div>
            </div>
            <div class="validation-stats">
                <div>Valid: <span id="valid-count">0</span></div>
                <div>Invalid: <span id="invalid-count">0</span></div>
            </div>
        </div>
        
        <div id="error-message" class="error-message"></div>
        
        <div id="result" class="result">
            <div class="result-header">
                <div class="result-title">CONFIGURATION GENERATED</div>
            </div>
            <div class="output-container">
                <textarea id="output" class="output" readonly></textarea>
            </div>
            <button id="copyLink" class="copy-btn">
                <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                COPY CONFIGURATION
            </button>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="circuit-line circuit-line-1"></div>
    <div class="circuit-line circuit-line-2"></div>
    <div class="circuit-line circuit-line-3"></div>
    <div class="circuit-line circuit-line-4"></div>
    <div class="circuit-dot circuit-dot-1"></div>
    <div class="circuit-dot circuit-dot-2"></div>
    <div class="circuit-dot circuit-dot-3"></div>
    <div class="circuit-dot circuit-dot-4"></div>
    
    <div class="footer-logo">XSM VPN</div>
    <div class="footer-powered">SUPPORT BY INCONIGTO MODE</div>
    <div class="footer-social">
        <a href="https://t.me/after_sweet" class="social-link" target="_blank">
            <svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-8.609 3.33c-2.068.8-4.133 1.598-5.724 2.21a405.15 405.15 0 0 1-2.849 1.09c-.42.147-.99.332-1.473.901-.728.968.193 1.798.919 2.286 1.61.516 3.275 1.009 4.654 1.472.846 1.467 1.618 2.796 2.503 4.532.545 1.062 1.587 2.739 3.19 2.756 1.26.033 2.052-.6 3.542-1.95a142.91 142.91 0 0 1 2.43-2.053c1.686-.142 3.382-.284 5.12-.436.887-.075 1.92-.262 2.405-1.226.436-.877-.015-1.35-.48-1.874l-3.881-4.369-5.481-6.174S22.185 2.128 21.198 2.433z"></path>
                <path d="M18.167 7.068c.237 1.632-1.162 6.872-1.766 8.849"></path>
            </svg>
            @after_sweet
        </a>
        <a href="https://t.me/InconigtoMode" class="social-link" target="_blank">
            <svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.198 2.433a2.242 2.242 0 0 0-1.022.215l-8.609 3.33c-2.068.8-4.133 1.598-5.724 2.21a405.15 405.15 0 0 1-2.849 1.09c-.42.147-.99.332-1.473.901-.728.968.193 1.798.919 2.286 1.61.516 3.275 1.009 4.654 1.472.846 1.467 1.618 2.796 2.503 4.532.545 1.062 1.587 2.739 3.19 2.756 1.26.033 2.052-.6 3.542-1.95a142.91 142.91 0 0 1 2.43-2.053c1.686-.142 3.382-.284 5.12-.436.887-.075 1.92-.262 2.405-1.226.436-.877-.015-1.35-.48-1.874l-3.881-4.369-5.481-6.174S22.185 2.128 21.198 2.433z"></path>
                <path d="M18.167 7.068c.237 1.632-1.162 6.872-1.766 8.849"></path>
            </svg>
            @InconigtoMode
        </a>
    </div>
    <div class="footer-year">© 2025</div>
</footer>

<script>
    // Constants
    const DEFAULT_PROXY_BANK_URL = 'https://raw.githubusercontent.com/xsm-syn/Nautica/refs/heads/main/proxyip.txt';
    //const PROXY_CHECK_API_URL = 'https://apicek.t-me-inconigto.workers.dev/proxy';
    //const PROXY_CHECK_API_URL = 'https://xsmnet.buzz/check';
    const PATH_PREFIX = 'Free-xsm'; // Hardcoded path prefix
    
    // Helper Functions
    function generateUUIDv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    // Safe base64 encoding function
    function safeBase64Encode(str) {
        try {
            // Make sure we're working with a string
            const stringToEncode = typeof str === 'object' ? JSON.stringify(str) : String(str);
            return window.btoa(stringToEncode);
        } catch (e) {
            console.error("Base64 encoding error:", e);
            return "";
        }
    }
    
    // Check if proxy is valid via API
    async function checkProxyValidity(ip, port) {
        try {
            const response = await fetch(`https://xsmnet.buzz/check?ip=${ip}:${port}`);
            
            if (!response.ok) {
                console.error(`API error: ${response.status}`);
                return false;
            }
            
            const data = await response.json();
            return data.proxyip === true;
        } catch (error) {
            console.error("Error checking proxy:", error);
            return false;
        }
    }
    
    // Create VMess config object
    function createVMessConfig(uuid, domain, host, sni, proxyHost, proxyPort, countryCode, isp, tls) {
        return {
            v: "2",
            ps: `${countryCode} - ${isp} [ VMESS - ${tls ? 'TLS' : 'NTLS'} ]`,
            add: domain,
            port: tls ? 443 : 80,
            id: uuid,
            aid: "0",
            net: "ws",
            type: "zero",
            host: host,
            path: `/${PATH_PREFIX}/${proxyHost}-${proxyPort}`,
            tls: tls ? "tls" : "none",
            sni: sni,
            fp: "randomized"
        };
    }
    
    // Format label with protocol and TLS info
    function formatLabel(countryCode, isp, protocol, tls) {
        return `${countryCode} - ${isp} [ ${protocol.toUpperCase()} - ${tls ? 'TLS' : 'NTLS'} ]`;
    }

    // Function to get country name from country code
    function getCountryName(countryCode) {
        return countryCode;
    }

    // Function to fetch and populate regions from GitHub
    async function populateRegionsFromGitHub() {
        try {
            const response = await fetch(DEFAULT_PROXY_BANK_URL);
            if (!response.ok) {
                throw new Error(`Failed to fetch proxy data: ${response.status}`);
            }
            
            const proxyList = (await response.text()).split('\n').filter(Boolean);
            
            // Extract unique country codes
            const uniqueCountryCodes = new Set();
            
            proxyList.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const countryCode = parts[2];
                    if (countryCode) {
                        uniqueCountryCodes.add(countryCode);
                    }
                }
            });
            
            // Sort country codes alphabetically
            const sortedCountryCodes = [...uniqueCountryCodes].sort();
            
            // Get the country select element
            const countrySelect = document.getElementById('country');
            
            // Keep the default options
            const defaultOptions = `
                <option value="">GLOBAL (ALL)</option>
                <option value="random">RANDOM</option>
            `;
            
            // Add the country codes from GitHub with their names
            let regionOptions = '';
            sortedCountryCodes.forEach(code => {
                regionOptions += `<option value="${code}">${code}</option>`;
            });
            
            // Update the select element
            countrySelect.innerHTML = defaultOptions + regionOptions;
            
            console.log(`Successfully loaded ${sortedCountryCodes.length} regions from GitHub`);
        } catch (error) {
            console.error("Error loading regions:", error);
        }
    }
    
    // Generate Clash YAML for VLESS
    function generateClashVLESS(name, uuid, domain, host, sni, proxyHost, proxyPort, tls) {
    return `- name: ${name}
  server: ${domain}
  port: ${tls ? 443 : 80}
  type: vless
  uuid: ${uuid}
  cipher: auto
  tls: ${tls}
  udp: false
  skip-cert-verify: true
  network: ws
  servername: ${sni}
  ws-opts:
    path: /${PATH_PREFIX}/${proxyHost}-${proxyPort}
    headers:
      Host: ${host}`;
}

    // Generate Clash YAML for Trojan
    function generateClashTrojan(name, uuid, domain, host, sni, proxyHost, proxyPort, tls) {
    return `- name: ${name}
  server: ${domain}
  port: ${tls ? 443 : 80}
  type: trojan
  password: ${uuid}
  udp: false
  skip-cert-verify: true
  network: ws
  sni: ${sni}
  ws-opts:
    path: /${PATH_PREFIX}/${proxyHost}-${proxyPort}
    headers:
      Host: ${host}`;
}

    // Generate Clash YAML for Shadowsocks
    function generateClashSS(name, uuid, domain, host, sni, proxyHost, proxyPort, tls) {
    return `- name: ${name}
  server: ${domain}
  port: ${tls ? 443 : 80}
  type: ss
  cipher: none
  password: ${uuid}
  plugin: v2ray-plugin
  client-fingerprint: chrome
  udp: false
  plugin-opts:
    mode: websocket
    host: ${host}
    path: /${PATH_PREFIX}/${proxyHost}-${proxyPort}
    tls: ${tls}
    mux: false
    skip-cert-verify: true
  headers:
    custom: value
    ip-version: dual
    v2ray-http-upgrade: false
    v2ray-http-upgrade-fast-open: false`;
}

    // Generate Clash YAML for VMess
    function generateClashVMess(name, uuid, domain, host, sni, proxyHost, proxyPort, tls) {
    return `- name: ${name}
  server: ${domain}
  port: ${tls ? 443 : 80}
  type: vmess
  uuid: ${uuid}
  alterId: 0
  cipher: zero
  tls: ${tls}
  skip-cert-verify: true
  servername: ${sni}
  network: ws
  ws-opts:
    path: /${PATH_PREFIX}/${proxyHost}-${proxyPort}
    headers:
      Host: ${host}
  udp: true`;
}
    
    // Main Function
    async function generateV2raySub(type, uuid, bugType, mainDomain, customBug, tls, validateProxies, formatType, country = null, limit = null) {
    try {
        const response = await fetch(DEFAULT_PROXY_BANK_URL);
        if (!response.ok) {
            throw new Error(`Failed to fetch proxy data: ${response.status}`);
        }
        
        const proxyList = (await response.text()).split('\n').filter(Boolean);
        let filteredProxies = proxyList;
        
        // Filter by country if specified
        if (country) {
            if (country.toLowerCase() === 'random') {
                filteredProxies = proxyList.sort(() => Math.random() - 0.5);
            } else {
                filteredProxies = proxyList.filter(line => {
                    const parts = line.split(',');
                    return parts.length >= 3 && parts[2]?.toUpperCase() === country.toUpperCase();
                });
            }
        }
        
        if (filteredProxies.length === 0) {
            throw new Error("No proxies found matching your region criteria");
        }
        
        // Apply limit to the filtered list before validation
        // This ensures we only validate the number of proxies we actually need
        let limitedProxies = filteredProxies;
        if (limit && !isNaN(limit) && limit > 0) {
            limitedProxies = filteredProxies.slice(0, parseInt(limit));
        }
        
        // Determine domain, host, and SNI based on bug type
        let domain, host, sni;
        
        switch (bugType) {
            case 'default':
                domain = mainDomain;
                host = mainDomain;
                sni = mainDomain;
                break;
            case 'non-wildcard':
                domain = customBug || mainDomain;
                host = mainDomain;
                sni = mainDomain;
                break;
            case 'wildcard':
                domain = customBug || mainDomain;
                host = `${customBug}.${mainDomain}`;
                sni = `${customBug}.${mainDomain}`;
                break;
        }
        
        const results = [];
        let validProxies = [];
        
        // Check proxy validity if enabled
        if (validateProxies) {
            // Show validation status UI
            document.getElementById('validation-status').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            // Initialize validation UI
            const validationBar = document.getElementById('validation-bar');
            const validationCount = document.getElementById('validation-count');
            const validCountEl = document.getElementById('valid-count');
            const invalidCountEl = document.getElementById('invalid-count');
            
            validationBar.style.width = '0%';
            validationCount.textContent = `0/${limitedProxies.length}`;
            validCountEl.textContent = '0';
            invalidCountEl.textContent = '0';
            
            // Prepare validation tasks in batches to avoid overwhelming the browser
            const BATCH_SIZE = 10; // Process 10 proxies at a time
            let validCount = 0;
            let invalidCount = 0;
            let processedCount = 0;
            
            // Process proxies in batches
            for (let i = 0; i < limitedProxies.length; i += BATCH_SIZE) {
                const batch = limitedProxies.slice(i, i + BATCH_SIZE);
                const batchPromises = batch.map(async (line) => {
                    const parts = line.split(',');
                    if (parts.length < 3) {
                        return { line, isValid: false };
                    }
                    
                    const [proxyHost, proxyPort] = parts;
                    const isValid = await checkProxyValidity(proxyHost, proxyPort);
                    return { line, isValid };
                });
                
                // Process batch in parallel
                const batchResults = await Promise.all(batchPromises);
                
                // Update counts and UI
                for (const result of batchResults) {
                    processedCount++;
                    
                    if (result.isValid) {
                        validCount++;
                        validProxies.push(result.line);
                    } else {
                        invalidCount++;
                    }
                    
                    // Update UI efficiently (using requestAnimationFrame to batch DOM updates)
                    if (processedCount % 3 === 0 || processedCount === limitedProxies.length) {
                        requestAnimationFrame(() => {
                            const percentage = (processedCount / limitedProxies.length) * 100;
                            validationBar.style.width = `${percentage}%`;
                            validationCount.textContent = `${processedCount}/${limitedProxies.length}`;
                            validCountEl.textContent = validCount;
                            invalidCountEl.textContent = invalidCount;
                        });
                    }
                }
            }
            
            // Use valid proxies for configuration generation
            if (validProxies.length === 0) {
                throw new Error("No valid proxies found matching your criteria");
            }
            
            // Hide validation status UI
            document.getElementById('validation-status').style.display = 'none';
            
            // Show loading again for config generation
            document.getElementById('loading').style.display = 'block';
            
            // Use the valid proxies for configuration
            limitedProxies = validProxies;
        }
        
        // For Clash format, we'll collect all proxies under a single header
        if (formatType === 'clash') {
            let allProxies = [];
            
            for (let i = 0; i < limitedProxies.length; i++) {
                const line = limitedProxies[i];
                const parts = line.split(',');
                if (parts.length < 3) continue;
                
                const [proxyHost, proxyPort, countryCode, ...ispParts] = parts;
                const isp = ispParts.join(' ') || 'Unknown';
                const name = `${countryCode} - ${isp} ${i+1}`;
                
                switch (type) {
                    case 'vless':
                        allProxies.push(generateClashVLESS(`${name}-[VLESS-${tls ? 'TLS' : 'NTLS'}]`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        break;
                    case 'vmess':
                        allProxies.push(generateClashVMess(`${name}-[VMESS-${tls ? 'TLS' : 'NTLS'}]`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        break;
                    case 'trojan':
                        allProxies.push(generateClashTrojan(`${name}-[TROJAN-${tls ? 'TLS' : 'NTLS'}]`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        break;
                    case 'shadowsocks':
                        allProxies.push(generateClashSS(`${name}-[SS-${tls ? 'TLS' : 'NTLS'}]`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        break;
                    case 'mix':
                        const mixIndex = i + 1;
                        allProxies.push(generateClashVLESS(`${countryCode} - ${isp}-[VLESS-${tls ? 'TLS' : 'NTLS'}] ${mixIndex}.1`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        allProxies.push(generateClashTrojan(`${countryCode} - ${isp}-[TROJAN-${tls ? 'TLS' : 'NTLS'}] ${mixIndex}.2`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        allProxies.push(generateClashSS(`${countryCode} - ${isp}-[SS-${tls ? 'TLS' : 'NTLS'}] ${mixIndex}.3`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        allProxies.push(generateClashVMess(`${countryCode} - ${isp}-[VMESS-${tls ? 'TLS' : 'NTLS'}] ${mixIndex}.4`, uuid, domain, host, sni, proxyHost, proxyPort, tls));
                        break;
                }
            }
            
            // Return a single Clash configuration with all proxies
            return `#Inconigto-Mode\nproxies:\n${allProxies.join('\n')}`;
        } else {
            // V2Ray format - process each proxy individually
            for (const line of limitedProxies) {
                const parts = line.split(',');
                if (parts.length < 3) continue;
                
                const [proxyHost, proxyPort, countryCode, ...ispParts] = parts;
                const isp = ispParts.join(' ') || 'Unknown';
                
                let config;
                
                switch (type) {
                    case 'vless': 
                        const vlessLabel = formatLabel(countryCode, isp, 'VLESS', tls);
                        config = `vless://${uuid}@${domain}:${tls ? 443 : 80}?encryption=none&security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(vlessLabel)}`;
                        break;
                    
                    case 'vmess': 
                        const vmessConfig = createVMessConfig(uuid, domain, host, sni, proxyHost, proxyPort, countryCode, isp, tls);
                        const vmessString = JSON.stringify(vmessConfig);
                        config = `vmess://${safeBase64Encode(vmessString)}`;
                        break;
                    
                    case 'trojan': 
                        const trojanLabel = formatLabel(countryCode, isp, 'TROJAN', tls);
                        config = `trojan://${uuid}@${domain}:${tls ? 443 : 80}?security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(trojanLabel)}`;
                        break;
                    
                    case 'shadowsocks': 
                        const ssLabel = formatLabel(countryCode, isp, 'SS', tls);
                        const ssAuth = `none:${uuid}`;
                        config = `ss://${safeBase64Encode(ssAuth)}@${domain}:${tls ? 443 : 80}?encryption=none&security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(ssLabel)}`;
                        break;
                    
                    case 'mix': 
                        // For mix, we'll create all protocol types with appropriate labels
                        const vmessConfigMix = createVMessConfig(uuid, domain, host, sni, proxyHost, proxyPort, countryCode, isp, tls);
                        const vmessStringMix = JSON.stringify(vmessConfigMix);
                        
                        const vlessLabelMix = formatLabel(countryCode, isp, 'VLESS', tls);
                        const trojanLabelMix = formatLabel(countryCode, isp, 'TROJAN', tls);
                        const ssLabelMix = formatLabel(countryCode, isp, 'SS', tls);
                        
                        const ssAuthMix = `none:${uuid}`;
                        
                        config = [
                            `vless://${uuid}@${domain}:${tls ? 443 : 80}?encryption=none&security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(vlessLabelMix)}`,
                            `vmess://${safeBase64Encode(vmessStringMix)}`,
                            `trojan://${uuid}@${domain}:${tls ? 443 : 80}?security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(trojanLabelMix)}`,
                            `ss://${safeBase64Encode(ssAuthMix)}@${domain}:${tls ? 443 : 80}?encryption=none&security=${tls ? 'tls' : 'none'}&type=ws&host=${host}&path=%2F${PATH_PREFIX}%2F${proxyHost}-${proxyPort}&sni=${sni}#${encodeURIComponent(ssLabelMix)}`
                        ].join('\n');
                        break;
                }
                
                if (config) {
                    results.push(config);
                }
            }
            
            return results.join('\n');
        }
    } catch (error) {
        console.error("Error generating subscription:", error);
        throw error;
    }
}
    
    // UI Interaction
    document.addEventListener('DOMContentLoaded', () => {
        // Populate regions from GitHub when the page loads
        populateRegionsFromGitHub();
    
        const form = document.getElementById('subLinkForm');
        const loadingEl = document.getElementById('loading');
        const resultEl = document.getElementById('result');
        const outputEl = document.getElementById('output');
        const copyLinkBtn = document.getElementById('copyLink');
        const errorMessageEl = document.getElementById('error-message');
        const generateUuidBtn = document.getElementById('generateUuid');
        const uuidInput = document.getElementById('uuid');
        const bugTypeSelect = document.getElementById('bugType');
        const customBugContainer = document.getElementById('customBugContainer');
        const validationStatusEl = document.getElementById('validation-status');
        
        // Show/hide custom bug field based on bug type
        bugTypeSelect.addEventListener('change', () => {
            if (bugTypeSelect.value === 'default') {
                customBugContainer.style.display = 'none';
            } else {
                customBugContainer.style.display = 'block';
            }
        });
        
        // UUID generator button
        generateUuidBtn.addEventListener('click', () => {
            uuidInput.value = generateUUIDv4();
        });
        
        // Form submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('configType').value;
            const uuid = document.getElementById('uuid').value.trim();
            const bugType = document.getElementById('bugType').value;
            const mainDomain = document.getElementById('mainDomain').value.trim();
            const customBug = document.getElementById('customBug').value.trim();
            const tls = document.getElementById('tls').value === 'true';
            const country = document.getElementById('country').value.trim() || null;
            const limit = document.getElementById('limit').value.trim() || null;
            const validateProxies = document.getElementById('validateProxies').checked;
            const formatType = document.getElementById('formatType').value;
            
            // Validation
            if (!uuid || !mainDomain) {
                errorMessageEl.textContent = 'ERROR: UUID and Main Domain are required';
                return;
            }
            
            if ((bugType === 'non-wildcard' || bugType === 'wildcard') && !customBug) {
                errorMessageEl.textContent = 'ERROR: Custom Bug is required for Non-Wildcard and Wildcard modes';
                return;
            }
            
            try {
                // Reset UI
                validationStatusEl.style.display = 'none';
                resultEl.style.display = 'none';
                errorMessageEl.textContent = '';
                
                // Update loading text based on validation setting
                const loadingTextEl = document.querySelector('.loading-text');
                loadingTextEl.textContent = validateProxies ? 
                    'Fetching proxy data and preparing to validate...' : 
                    'Fetching proxy data and generating configs...';
                
                // Show loading
                loadingEl.style.display = 'block';
                
                // Generate subscription
                const result = await generateV2raySub(
                    type, uuid, bugType, mainDomain, customBug, tls, validateProxies, formatType, country, limit
                );
                
                // Hide loading
                loadingEl.style.display = 'none';
                
                // Display result
                outputEl.value = result;
                resultEl.style.display = 'block';
            } catch (error) {
                loadingEl.style.display = 'none';
                validationStatusEl.style.display = 'none';
                errorMessageEl.textContent = 'ERROR: ' + error.message;
                console.error(error);
            }
        });
        
        // Copy functionality
        copyLinkBtn.addEventListener('click', () => {
            outputEl.select();
            document.execCommand('copy');
            
            const originalText = copyLinkBtn.textContent;
            copyLinkBtn.textContent = '✓ COPIED SUCCESSFULLY';
            copyLinkBtn.style.background = 'linear-gradient(90deg, var(--color-success), var(--color-success))';
            
            setTimeout(() => {
                copyLinkBtn.textContent = originalText;
                copyLinkBtn.style.background = 'linear-gradient(90deg, var(--color-success), var(--color-primary))';
            }, 2000);
        });
    });
</script>
</body>
</html>
